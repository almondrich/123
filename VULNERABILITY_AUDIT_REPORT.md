# üîí Security Vulnerability Audit Report
## Pre-Hospital Care System

**Date:** 2025-01-27  
**Application:** Pre-Hospital Care Form System (PHP)  
**Auditor:** Security Analysis

---

## üìä Executive Summary

This security audit identified **15 vulnerabilities** ranging from **CRITICAL** to **LOW** severity. The application has good security foundations (prepared statements, CSRF protection, rate limiting), but several critical issues must be addressed before production deployment.

### Risk Summary
- **üî¥ CRITICAL:** 4 issues
- **üü† HIGH:** 5 issues  
- **üü° MEDIUM:** 4 issues
- **üü¢ LOW:** 2 issues

---

## üî¥ CRITICAL VULNERABILITIES

### 1. Path Traversal in File Serving (`api/serve_file.php`)
**Severity:** CRITICAL  
**CVSS Score:** 9.1 (Critical)  
**File:** `api/serve_file.php:16-30`

**Issue:**
```php
$filePath = $_GET['file'] ?? '';
$realPath = realpath($filePath);
$uploadDir = realpath(UPLOAD_DIR);

if (!$realPath || !$uploadDir || strpos($realPath, $uploadDir) !== 0) {
    http_response_code(403);
    die('Access denied');
}
```

**Problem:**
- Uses `$_GET['file']` directly without proper sanitization
- `realpath()` can return `false` for non-existent files, allowing bypass
- Path traversal attacks possible: `../../../etc/passwd`, `../../config.php`

**Impact:**
- Read arbitrary files from the server
- Access configuration files, database credentials, source code
- System compromise

**Fix:**
```php
$filePath = $_GET['file'] ?? '';
if (empty($filePath)) {
    http_response_code(400);
    die('Invalid file path');
}

// Sanitize: remove directory traversal attempts
$filePath = basename($filePath); // Remove any path components
$filePath = preg_replace('/[^a-zA-Z0-9._-]/', '', $filePath); // Only allow safe chars

// Construct full path from upload directory only
$uploadDir = realpath(UPLOAD_DIR);
if (!$uploadDir) {
    http_response_code(500);
    die('Upload directory not found');
}

$realPath = $uploadDir . DIRECTORY_SEPARATOR . $filePath;

// Verify file exists and is within upload directory
if (!file_exists($realPath) || !is_file($realPath)) {
    http_response_code(404);
    die('File not found');
}

// Double-check path is within upload directory
if (strpos(realpath($realPath), $uploadDir) !== 0) {
    http_response_code(403);
    die('Access denied');
}
```

---

### 2. Missing Authorization Checks - Record Access Control
**Severity:** CRITICAL  
**CVSS Score:** 8.5 (High)  
**Files:** 
- `public/view_record.php:23-25`
- `public/edit_record.php:28-30`
- `api/update_record.php:38-44`
- `api/delete_record.php:34-40`
- `public/api/get_record.php:38-44`

**Issue:**
Any authenticated user can view, edit, or delete ANY record by simply changing the record ID in the URL. There is no check to verify:
- The user owns the record (`created_by = user_id`)
- The user is an admin
- The user has permission to access the record

**Example Attack:**
```php
// User with ID 2 can access record created by user ID 1
GET /public/view_record.php?id=1
GET /api/update_record.php (POST with record_id=1)
DELETE /api/delete_record.php (POST with id=1)
```

**Impact:**
- Unauthorized access to sensitive medical records
- Data breach (HIPAA/GDPR violations)
- Data tampering
- Data deletion

**Fix:**
Add authorization checks in all record access endpoints:

```php
// In view_record.php, edit_record.php, update_record.php, delete_record.php
$record_id = isset($_GET['id']) ? (int)$_GET['id'] : 0;

// Get record details
$sql = "SELECT * FROM prehospital_forms WHERE id = ?";
$stmt = db_query($sql, [$record_id]);
$record = $stmt->fetch();

if (!$record) {
    set_flash('Record not found', 'error');
    redirect('records.php');
}

// AUTHORIZATION CHECK - ADD THIS
$current_user = get_auth_user();
if ($record['created_by'] != $current_user['id'] && !is_admin()) {
    set_flash('Access denied. You do not have permission to access this record.', 'error');
    redirect('records.php');
}
```

---

### 3. Default Database Credentials
**Severity:** CRITICAL  
**CVSS Score:** 9.8 (Critical)  
**File:** `includes/config.php:22-25`

**Issue:**
```php
define('DB_HOST', 'localhost');
define('DB_NAME', 'pre_hospital_db');
define('DB_USER', 'root');
define('DB_PASS', ''); // ‚Üê EMPTY PASSWORD
```

**Impact:**
- Database compromise if exposed
- Full access to all medical records
- Data theft, modification, deletion
- System compromise

**Fix:**
1. Create a dedicated database user with minimal privileges
2. Set a strong password (16+ characters, mixed case, numbers, symbols)
3. Use environment variables or a separate config file outside web root
4. Never commit credentials to version control

```php
// Use environment variables or .env file
define('DB_HOST', getenv('DB_HOST') ?: 'localhost');
define('DB_NAME', getenv('DB_NAME') ?: 'pre_hospital_db');
define('DB_USER', getenv('DB_USER') ?: 'app_user');
define('DB_PASS', getenv('DB_PASS') ?: '');
```

---

### 4. Test reCAPTCHA Keys in Production
**Severity:** CRITICAL  
**CVSS Score:** 7.5 (High)  
**File:** `includes/config.php:36-37`

**Issue:**
```php
define('RECAPTCHA_SITE_KEY', '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI');
define('RECAPTCHA_SECRET_KEY', '6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe');
```

These are Google's **test keys** that always pass validation. They provide NO protection.

**Impact:**
- Bots can bypass CAPTCHA protection
- Automated attacks on login
- Brute force attacks enabled
- Account enumeration

**Fix:**
1. Get real reCAPTCHA keys from https://www.google.com/recaptcha/admin
2. Use reCAPTCHA v3 for better user experience
3. Store keys in environment variables
4. Never commit keys to version control

---

## üü† HIGH SEVERITY VULNERABILITIES

### 5. Files Stored in Public Directory
**Severity:** HIGH  
**CVSS Score:** 7.2 (High)  
**File:** `api/TONYANG_save.php:90`

**Issue:**
```php
$uploadDir = '../public/uploads/endorsements/';
```

Uploaded files are stored in the public web directory, making them directly accessible via URL.

**Impact:**
- Direct file access without authentication
- Bypass access control
- Information disclosure
- Potential XSS if malicious files are uploaded

**Fix:**
1. Move uploads outside the public directory:
```php
// Store in: /var/www/uploads/endorsements/ (outside public_html)
$uploadDir = __DIR__ . '/../../uploads/endorsements/';
```

2. Serve files through `serve_file.php` with authentication
3. Add `.htaccess` to block direct access (if using Apache):
```apache
# In public/uploads/.htaccess
Deny from all
```

---

### 6. Unsafe JSON Decoding
**Severity:** HIGH  
**CVSS Score:** 7.0 (High)  
**Files:** 
- `api/TONYANG_save.php:290`
- `public/edit_record.php:125`

**Issue:**
```php
$injuries_data = isset($_POST['injuries']) ? json_decode($_POST['injuries'], true) : [];
```

No validation on JSON input. Malicious JSON could cause:
- Memory exhaustion (deeply nested JSON)
- PHP object injection (if `json_decode` used unsafely)
- Array size limits bypassed

**Fix:**
```php
$injuries_json = $_POST['injuries'] ?? '[]';

// Validate JSON size (prevent huge payloads)
if (strlen($injuries_json) > 100000) { // 100KB max
    throw new Exception('Injuries data too large');
}

// Decode with depth limit
$injuries_data = json_decode($injuries_json, true, 10); // Max depth 10

// Validate JSON decode
if (json_last_error() !== JSON_ERROR_NONE) {
    throw new Exception('Invalid JSON format: ' . json_last_error_msg());
}

// Validate array structure
if (!is_array($injuries_data)) {
    throw new Exception('Injuries data must be an array');
}

// Limit array size
if (count($injuries_data) > 100) {
    throw new Exception('Too many injuries (max 100)');
}

// Validate each injury entry
foreach ($injuries_data as $injury) {
    if (!is_array($injury)) {
        throw new Exception('Invalid injury entry');
    }
    // Validate required fields
    if (!isset($injury['id']) || !isset($injury['type']) || !isset($injury['view'])) {
        throw new Exception('Missing required injury fields');
    }
    // Validate types
    if (!is_int($injury['id']) || !is_string($injury['type']) || !is_string($injury['view'])) {
        throw new Exception('Invalid injury data types');
    }
}
```

---

### 7. Missing Input Validation on Record ID
**Severity:** HIGH  
**CVSS Score:** 6.5 (Medium)  
**Files:** Multiple API endpoints

**Issue:**
While record IDs are cast to integers, there's no validation that:
- The ID is within reasonable bounds
- The ID matches expected format
- The ID hasn't been tampered with

**Fix:**
```php
$record_id = isset($_GET['id']) ? (int)$_GET['id'] : 0;

// Additional validation
if ($record_id <= 0 || $record_id > 2147483647) { // Max MySQL INT
    throw new Exception('Invalid record ID');
}

// Verify ID format (prevent injection attempts)
if (!preg_match('/^\d+$/', (string)$_GET['id'])) {
    throw new Exception('Invalid record ID format');
}
```

---

### 8. Information Disclosure in Error Messages
**Severity:** HIGH  
**CVSS Score:** 6.2 (Medium)  
**Files:** Multiple

**Issue:**
Some error messages may leak sensitive information:
- Database errors expose table structure
- File paths exposed in errors
- Stack traces in development mode

**Example:**
```php
// api/delete_record.php:74
error_log("Delete Record Error: " . $e->getMessage());
```

While errors are logged (good), ensure they're not displayed to users.

**Fix:**
1. Already implemented in `config.php` (errors hidden, logged)
2. Ensure all error handling follows this pattern
3. Use generic error messages for users:
```php
catch (Exception $e) {
    error_log("Delete Record Error: " . $e->getMessage());
    json_response([
        'success' => false,
        'message' => 'An error occurred. Please try again.'
    ], 500);
}
```

---

### 9. Missing CSRF Protection on Some Endpoints
**Severity:** HIGH  
**CVSS Score:** 6.8 (Medium)  
**Files:** 
- `api/delete_record.php` (uses JSON, no CSRF check)
- `public/api/get_record.php` (GET request, but should verify token for state-changing operations)

**Issue:**
`delete_record.php` accepts JSON POST without CSRF token verification.

**Fix:**
```php
// In delete_record.php
$input = json_decode(file_get_contents('php://input'), true);
$csrf_token = $input['csrf_token'] ?? '';

if (!verify_token($csrf_token)) {
    json_response(['success' => false, 'message' => 'Invalid security token'], 403);
}
```

---

## üü° MEDIUM SEVERITY VULNERABILITIES

### 10. Weak Session Security
**Severity:** MEDIUM  
**CVSS Score:** 5.3 (Medium)  
**File:** `includes/config.php:49-57`

**Issue:**
While session security is configured, some improvements needed:
- Session timeout not explicitly set
- No session inactivity timeout
- Session ID rotation could be more frequent

**Fix:**
```php
// In config.php
ini_set('session.cookie_httponly', 1);
ini_set('session.use_only_cookies', 1);
ini_set('session.cookie_samesite', 'Strict');
ini_set('session.gc_maxlifetime', 3600); // 1 hour
ini_set('session.cookie_lifetime', 0); // Until browser closes

// Add session timeout check
if (isset($_SESSION['last_activity']) && (time() - $_SESSION['last_activity'] > 3600)) {
    session_unset();
    session_destroy();
    redirect('../public/login.php');
}
$_SESSION['last_activity'] = time();
```

---

### 11. Insufficient Rate Limiting on Export
**Severity:** MEDIUM  
**CVSS Score:** 5.0 (Medium)  
**File:** `api/export_records.php`

**Issue:**
Export endpoint has no rate limiting, allowing:
- Resource exhaustion (large exports)
- Data exfiltration at scale
- DoS attacks

**Fix:**
```php
// Add rate limiting
if (!check_rate_limit('export_records', 10, 3600)) { // 10 exports per hour
    set_flash('Too many export requests. Please wait.', 'error');
    redirect('../public/records.php');
}

// Add result limit
$sql .= " LIMIT 10000"; // Max 10,000 records per export
```

---

### 12. Missing Content Security Policy Headers
**Severity:** MEDIUM  
**CVSS Score:** 4.5 (Medium)  
**Files:** Multiple PHP files

**Issue:**
While CSP nonce is generated, CSP headers are not consistently set across all pages.

**Fix:**
Add CSP headers to all pages:
```php
// In config.php or a common header file
$csp_nonce = CSP_NONCE;
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-$csp_nonce' https://cdn.jsdelivr.net https://www.google.com; style-src 'self' 'nonce-$csp_nonce' https://cdn.jsdelivr.net; img-src 'self' data:; font-src 'self' https://cdn.jsdelivr.net;");
```

---

### 13. Weak Password Requirements (Already Fixed)
**Severity:** MEDIUM (Now LOW - Already Fixed)  
**Status:** ‚úÖ FIXED  
**File:** `includes/functions.php:150-177`

**Note:** Strong password requirements have been implemented. No action needed.

---

## üü¢ LOW SEVERITY VULNERABILITIES

### 14. Missing Security Headers
**Severity:** LOW  
**CVSS Score:** 3.1 (Low)  
**Files:** Multiple

**Issue:**
Some security headers missing:
- `Strict-Transport-Security` (HSTS)
- `X-Permitted-Cross-Domain-Policies`
- `Referrer-Policy`

**Fix:**
```php
// Add to config.php or common header file
header("Strict-Transport-Security: max-age=31536000; includeSubDomains");
header("X-Permitted-Cross-Domain-Policies: none");
header("Referrer-Policy: strict-origin-when-cross-origin");
header("Permissions-Policy: geolocation=(), microphone=(), camera=()");
```

---

### 15. Verbose Error Logging
**Severity:** LOW  
**CVSS Score:** 2.5 (Low)  
**Files:** Multiple

**Issue:**
Error logs may contain sensitive information that could aid attackers if log files are compromised.

**Fix:**
Sanitize error logs:
```php
function safe_error_log($message, $context = []) {
    // Remove sensitive data from logs
    $message = preg_replace('/password[=:]\s*\S+/i', 'password=***', $message);
    $message = preg_replace('/token[=:]\s*\S+/i', 'token=***', $message);
    error_log($message);
}
```

---

## ‚úÖ SECURITY STRENGTHS

The application has several good security practices:

1. ‚úÖ **Prepared Statements** - All database queries use PDO prepared statements
2. ‚úÖ **CSRF Protection** - Most forms have CSRF token verification
3. ‚úÖ **Rate Limiting** - Login and admin actions have rate limiting
4. ‚úÖ **Password Hashing** - Uses `password_hash()` with `PASSWORD_DEFAULT`
5. ‚úÖ **Input Sanitization** - `sanitize()` function used throughout
6. ‚úÖ **Session Security** - HttpOnly, SameSite cookies configured
7. ‚úÖ **File Upload Validation** - MIME type, file size, extension validation
8. ‚úÖ **Account Lockout** - Failed login attempts tracked and accounts locked
9. ‚úÖ **Activity Logging** - Security events and activities logged
10. ‚úÖ **Error Display Disabled** - Errors logged but not displayed to users

---

## üìã RECOMMENDED FIX PRIORITY

### Immediate (Before Production):
1. üî¥ Fix path traversal in `serve_file.php`
2. üî¥ Add authorization checks for record access
3. üî¥ Change default database credentials
4. üî¥ Replace test reCAPTCHA keys
5. üü† Move uploads outside public directory

### Short Term (Within 1 Week):
6. üü† Add JSON validation for injuries data
7. üü† Add CSRF protection to delete endpoint
8. üü† Add rate limiting to export endpoint
9. üü° Improve session security
10. üü° Add consistent CSP headers

### Medium Term (Within 1 Month):
11. üü° Add missing security headers
12. üü¢ Sanitize error logs
13. üü¢ Security headers audit

---

## üß™ TESTING RECOMMENDATIONS

1. **Penetration Testing:**
   - Test path traversal attacks
   - Test authorization bypass
   - Test CSRF protection
   - Test rate limiting

2. **Security Scanning:**
   - Run OWASP ZAP or similar
   - Check for SQL injection (even with prepared statements)
   - Check for XSS vulnerabilities
   - Check for XXE vulnerabilities

3. **Code Review:**
   - Review all user input handling
   - Review all file operations
   - Review all database queries
   - Review authentication/authorization logic

---

## üìö REFERENCES

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP PHP Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/PHP_Configuration_Cheat_Sheet.html)
- [CWE-22: Path Traversal](https://cwe.mitre.org/data/definitions/22.html)
- [CWE-284: Improper Access Control](https://cwe.mitre.org/data/definitions/284.html)
- [CWE-798: Use of Hard-coded Credentials](https://cwe.mitre.org/data/definitions/798.html)

---

## üìù CONCLUSION

The application has a solid security foundation but requires critical fixes before production deployment. The most urgent issues are:

1. Path traversal vulnerability in file serving
2. Missing authorization checks on record access
3. Default database credentials
4. Test reCAPTCHA keys

Once these are addressed, the application will be significantly more secure and ready for production use.

---

**Report Generated:** 2025-01-27  
**Next Review:** After fixes are applied
